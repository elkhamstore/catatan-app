<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Catatan Harian Multi-Akun (Edit)</title>
  <style>
    :root {
      --bg: #f0f0f0;
      --fg: #000;
      --box: #fff;
      --accent: #4CAF50;
      --button-text: #fff;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #1e1e1e;
        --fg: #f0f0f0;
        --box: #2a2a2a;
        --accent: #81c784;
        --button-text: #000;
      }
    }
    body.dark {
      --bg: #1e1e1e;
      --fg: #f0f0f0;
      --box: #2a2a2a;
      --accent: #81c784;
      --button-text: #000;
    }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--fg);
      transition: background 0.3s, color 0.3s;
    }
    .container {
      max-width: 500px;
      margin: 60px auto;
      background: var(--box);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      background: var(--bg);
      color: var(--fg);
    }
    button {
      width: 100%;
      padding: 10px;
      background: var(--accent);
      color: var(--button-text);
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    button:hover { opacity: 0.9; }
    .hidden { display: none; }
    ul {
      list-style: none;
      padding: 0;
      margin-top: 20px;
    }
    li {
      background: #eee;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 8px;
      position: relative;
    }
    body.dark li { background: #3a3a3a; }
    .delete {
      position: absolute;
      right: 10px;
      top: 10px;
      color: red;
      cursor: pointer;
      font-weight: bold;
    }
    .timestamp {
      font-size: 11px;
      color: gray;
    }
    .edit-input {
      width: 100%;
      padding: 6px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #aaa;
    }
  </style>
</head>
<body>
  <div class="container" id="authContainer">
    <h2>üë§ Login Akun</h2>
    <input type="text" id="loginUser" placeholder="Username" />
    <input type="password" id="loginPin" placeholder="PIN" />
    <button onclick="login()">Login</button>
    <hr>
    <h2>üìù Daftar Akun Baru</h2>
    <input type="text" id="regUser" placeholder="Username baru" />
    <input type="password" id="regPin" placeholder="PIN baru" />
    <button onclick="register()">Daftar</button>
  </div>

  <div class="container hidden" id="noteContainer">
    <h2 id="welcomeTitle">üìí Catatan</h2>
    <button onclick="logout()">Logout</button>
    <button onclick="toggleDark()">üåì Toggle Dark Mode</button>
    <button onclick="showChangePinForm()">üîí Ganti PIN</button>
    <textarea id="noteInput" placeholder="Tulis catatan..."></textarea>
    <button onclick="addNote()">Tambah Catatan</button>
    <button onclick="exportToPDF()">üñ®Ô∏è Ekspor ke PDF</button>
    <button onclick="exportToJSON()">üì§ Ekspor ke JSON</button>
    <input type="file" id="importInput" accept=".json" onchange="importFromJSON()" />
    <ul id="noteList"></ul>
  <div id="changePinForm" class="hidden" style="margin-top: 20px; position: relative;">
  <span onclick="hideChangePinForm()" style="position:absolute; top:0; right:0; font-weight:bold; cursor:pointer;">‚úñ</span>
    <h3>üîí Ganti PIN</h3>
    <input type="password" id="oldPin" placeholder="PIN Lama" />
    <input type="password" id="newPin" placeholder="PIN Baru" />
    <input type="password" id="confirmPin" placeholder="Konfirmasi PIN Baru" />
    <button onclick="changePin()">Simpan PIN Baru</button>
  </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
    async function exportToPDF() {
      const {{ jsPDF }} = window.jspdf;
      const doc = new jsPDF();
      const users = getUsers();
      const notes = users[currentUser]?.notes || [];

      doc.setFont("helvetica");
      doc.setFontSize(12);
      doc.text(`Catatan - ${currentUser}`, 10, 10);

      let y = 20;
      notes.forEach((note, i) => {
        const text = `- ${note.text}`;
        const date = new Date(note.timestamp).toLocaleString("id-ID");
        doc.text(text, 10, y);
        y += 6;
        doc.setFontSize(10);
        doc.text(`  (${date})`, 12, y);
        doc.setFontSize(12);
        y += 8;
        if (y > 280) {{
          doc.addPage();
          y = 20;
        }}
      });

      doc.save(`catatan-${currentUser}.pdf`);
    }


    function showChangePinForm() {
      const form = document.getElementById("changePinForm");
      form.classList.toggle("hidden");
    }

    function changePin() {
      const oldPin = document.getElementById("oldPin").value.trim();
      const newPin = document.getElementById("newPin").value.trim();
      const confirmPin = document.getElementById("confirmPin").value.trim();
      const users = getUsers();

      if (users[currentUser].pin !== oldPin) {
        return alert("PIN lama salah.");
      }

      if (!newPin || newPin !== confirmPin) {
        return alert("PIN baru tidak cocok atau kosong.");
      }

      users[currentUser].pin = newPin;
      saveUsers(users);

      // Bersihkan input
      document.getElementById("oldPin").value = "";
      document.getElementById("newPin").value = "";
      document.getElementById("confirmPin").value = "";
      document.getElementById("changePinForm").classList.add("hidden");

      alert("PIN berhasil diganti.");
    }


    function hideChangePinForm() {
      document.getElementById("changePinForm").classList.add("hidden");
      document.getElementById("oldPin").value = "";
      document.getElementById("newPin").value = "";
      document.getElementById("confirmPin").value = "";
    }

</script>
  <script>
    let currentUser = null;

    function getUsers() {
      return JSON.parse(localStorage.getItem("users") || "{}");
    }

    function saveUsers(users) {
      localStorage.setItem("users", JSON.stringify(users));
    }

    function register() {
      const username = document.getElementById("regUser").value.trim();
      const pin = document.getElementById("regPin").value.trim();
      if (!username || !pin) return alert("Isi semua kolom.");
      const users = getUsers();
      if (users[username]) return alert("Username sudah terdaftar.");
      users[username] = { pin, notes: [] };
      saveUsers(users);
      document.getElementById("regUser").value = "";
      document.getElementById("regPin").value = "";
      document.getElementById("loginUser").value = username;
      document.getElementById("loginPin").value = "";
      document.getElementById("loginPin").focus();
      alert("Pendaftaran berhasil. Silakan login.");
    }

    function login() {
      const username = document.getElementById("loginUser").value.trim();
      const pin = document.getElementById("loginPin").value.trim();
      const users = getUsers();
      if (!users[username] || users[username].pin !== pin) {
        return alert("Username atau PIN salah.");
      }
      currentUser = username;
      localStorage.setItem("currentUser", currentUser);
      document.getElementById("authContainer").classList.add("hidden");
      document.getElementById("noteContainer").classList.remove("hidden");
      document.getElementById("welcomeTitle").innerText = `üìí Catatan (${currentUser})`;
      renderNotes();
      resetIdleTimer();
    }

    function logout() {
      localStorage.removeItem("currentUser");
      location.reload();
    }

    function addNote() {
      const text = document.getElementById("noteInput").value.trim();
      if (!text) return alert("Catatan kosong.");
      const users = getUsers();
      users[currentUser].notes.push({ text, timestamp: new Date().toISOString() });
      saveUsers(users);
      document.getElementById("noteInput").value = "";
      renderNotes();
    }

    function deleteNote(index) {
      if (!confirm("Yakin ingin menghapus catatan ini?")) return;
      const users = getUsers();
      users[currentUser].notes.splice(index, 1);
      saveUsers(users);
      renderNotes();
    }

    function editNote(index, newText) {
      const users = getUsers();
      users[currentUser].notes[index].text = newText;
      saveUsers(users);
      renderNotes();
    }

    
function renderNotes() {
  const users = getUsers();
  const notes = users[currentUser]?.notes || [];
  const list = document.getElementById("noteList");
  list.innerHTML = "";
  notes.forEach((note, i) => {
    const li = document.createElement("li");

    const span = document.createElement("span");
    span.textContent = note.text;
    span.style.display = "inline-block";
    span.style.width = "100%";
    span.style.cursor = "pointer";
    span.onclick = function () {
      span.contentEditable = true;
      span.focus();
    };
    span.onblur = function () {
      span.contentEditable = false;
      editNote(i, span.textContent.trim());
    };
    span.onkeydown = function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        span.blur();
      }
    };

    const time = document.createElement("div");
    time.className = "timestamp";
    time.textContent = new Date(note.timestamp).toLocaleString("id-ID");

    const del = document.createElement("span");
    del.className = "delete";
    del.textContent = "√ó";
    del.onclick = () => deleteNote(i);

    li.appendChild(span);
    li.appendChild(time);
    li.appendChild(del);
    list.appendChild(li);
  });
}


    function exportToJSON() {
      const users = getUsers();
      const notes = users[currentUser]?.notes || [];
      const blob = new Blob([JSON.stringify(notes, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `catatan-${currentUser}.json`;
      link.click();
    }

    function importFromJSON() {
      const file = document.getElementById("importInput").files[0];
      if (!file || !currentUser) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (!Array.isArray(imported)) return alert("Format file tidak valid.");
          const users = getUsers();
          users[currentUser].notes = users[currentUser].notes.concat(imported);
          saveUsers(users);
          renderNotes();
          alert("Impor berhasil.");
        } catch {
          alert("Gagal membaca file JSON.");
        }
      };
      reader.readAsText(file);
    }

    function toggleDark() {
      document.body.classList.toggle("dark");
    }

    window.onload = function () {
      const savedUser = localStorage.getItem("currentUser");
      if (savedUser && getUsers()[savedUser]) {
        currentUser = savedUser;
        document.getElementById("authContainer").classList.add("hidden");
        document.getElementById("noteContainer").classList.remove("hidden");
        document.getElementById("welcomeTitle").innerText = `üìí Catatan (${currentUser})`;
        renderNotes();
        resetIdleTimer();
      }
    }

    // === [Auto Logout After Idle] ===
    let idleTimer;
    function resetIdleTimer() {
      clearTimeout(idleTimer);
      idleTimer = setTimeout(() => {
        alert("Kamu telah logout karena tidak aktif selama 2 menit.");
        logout();
      }, 2 * 60 * 1000);
    }
    ["click", "mousemove", "keydown"].forEach(event => {
      document.addEventListener(event, resetIdleTimer, true);
    });
  
    async function exportToPDF() {
      const {{ jsPDF }} = window.jspdf;
      const doc = new jsPDF();
      const users = getUsers();
      const notes = users[currentUser]?.notes || [];

      doc.setFont("helvetica");
      doc.setFontSize(12);
      doc.text(`Catatan - ${currentUser}`, 10, 10);

      let y = 20;
      notes.forEach((note, i) => {
        const text = `- ${note.text}`;
        const date = new Date(note.timestamp).toLocaleString("id-ID");
        doc.text(text, 10, y);
        y += 6;
        doc.setFontSize(10);
        doc.text(`  (${date})`, 12, y);
        doc.setFontSize(12);
        y += 8;
        if (y > 280) {{
          doc.addPage();
          y = 20;
        }}
      });

      doc.save(`catatan-${currentUser}.pdf`);
    }


    function showChangePinForm() {
      const form = document.getElementById("changePinForm");
      form.classList.toggle("hidden");
    }

    function changePin() {
      const oldPin = document.getElementById("oldPin").value.trim();
      const newPin = document.getElementById("newPin").value.trim();
      const confirmPin = document.getElementById("confirmPin").value.trim();
      const users = getUsers();

      if (users[currentUser].pin !== oldPin) {
        return alert("PIN lama salah.");
      }

      if (!newPin || newPin !== confirmPin) {
        return alert("PIN baru tidak cocok atau kosong.");
      }

      users[currentUser].pin = newPin;
      saveUsers(users);

      // Bersihkan input
      document.getElementById("oldPin").value = "";
      document.getElementById("newPin").value = "";
      document.getElementById("confirmPin").value = "";
      document.getElementById("changePinForm").classList.add("hidden");

      alert("PIN berhasil diganti.");
    }


    function hideChangePinForm() {
      document.getElementById("changePinForm").classList.add("hidden");
      document.getElementById("oldPin").value = "";
      document.getElementById("newPin").value = "";
      document.getElementById("confirmPin").value = "";
    }

</script>
</body>
</html>
